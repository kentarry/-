<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æ©Ÿç›¤é»ç³»çµ± V3.8 - æ–°å¢æœå°‹åŠŸèƒ½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; padding-bottom: 140px; }
        .tab-active { color: #2563eb; border-bottom: 3px solid #2563eb; font-weight: bold; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* è¨­å®šå€å¡Šæ¨£å¼ */
        .settings-box { background: #374151; color: white; font-size: 12px; padding: 8px; }
        .settings-content { display: none; margin-top: 8px; }
        .settings-box.open .settings-content { display: block; }
        canvas { touch-action: none; cursor: crosshair; }
        /* è¼¸å…¥æ¡†æ¨£å¼å¾®èª¿ */
        .detail-input { font-size: 12px; padding: 6px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; }
        .detail-input:focus { border-color: #3b82f6; outline: none; ring: 2px; }
    </style>
</head>
<body>

    <!-- ç³»çµ±è¨­å®šå€å¡Š -->
    <div id="settings-area" class="settings-box">
        <div class="flex justify-between items-center cursor-pointer" onclick="toggleSettings()">
            <span><i class="fas fa-cog mr-1"></i> ç³»çµ±é€£ç·šè¨­å®š (è‹¥é€£ç·šå¤±æ•—è«‹é»æ­¤æª¢æŸ¥)</span>
            <i class="fas fa-chevron-down transform transition-transform" id="settings-arrow"></i>
        </div>
        <div class="settings-content">
            <label class="block text-gray-400 mb-1">Google Apps Script URL (å¾Œç«¯ç¶²å€):</label>
            <input type="text" id="api-url-input" class="w-full p-2 text-black rounded mb-2 text-xs font-mono" 
                   placeholder="https://script.google.com/..." 
                   onchange="saveApiUrl()">
            <div class="flex gap-2">
                <button onclick="saveApiUrl(); showMessage('è¨­å®šå·²å„²å­˜', 'ç¶²å€å·²æ›´æ–°ï¼Œç³»çµ±å°‡é‡æ–°æ•´ç†ã€‚', () => location.reload());" class="bg-blue-600 px-3 py-1 rounded hover:bg-blue-500">å„²å­˜ä¸¦é‡æ•´</button>
                <button onclick="resetApiUrl()" class="bg-red-600 px-3 py-1 rounded hover:bg-red-500">æ¢å¾©é è¨­å€¼</button>
            </div>
        </div>
    </div>

    <!-- Loading é®ç½© -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-600 mb-4"></div>
        <p class="text-gray-600 font-bold" id="loading-text">è™•ç†ä¸­...</p>
    </div>

    <!-- é€šç”¨è¨Šæ¯/ç¢ºèªè¦–çª— -->
    <div id="system-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[200]">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100">
            <div id="modal-header" class="bg-gray-800 p-4 text-white font-bold flex items-center">
                <i id="modal-icon" class="fas fa-info-circle mr-2"></i>
                <span id="modal-title">ç³»çµ±è¨Šæ¯</span>
            </div>
            <div class="p-6">
                <p id="modal-message" class="text-gray-700 text-sm mb-6 leading-relaxed whitespace-pre-wrap">è¨Šæ¯å…§å®¹...</p>
                <div class="flex gap-3" id="modal-actions"></div>
            </div>
        </div>
    </div>

    <!-- ç°½åæ¿ Modal -->
    <div id="signature-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[150]">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col">
            <div class="bg-blue-600 p-3 text-white flex justify-between items-center">
                <h3 class="font-bold"><i class="fas fa-pen-nib mr-2"></i>å€Ÿç”¨äººç°½å</h3>
                <button onclick="closeSignatureModal(false)"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 flex-1 bg-gray-100 flex justify-center">
                <canvas id="sig-canvas" class="bg-white border-2 border-dashed border-gray-400 rounded shadow-inner" width="300" height="150"></canvas>
            </div>
            <div class="p-4 bg-white border-t flex gap-3">
                <button onclick="clearSignature()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50"><i class="fas fa-eraser mr-1"></i>æ¸…é™¤</button>
                <button onclick="confirmSignature()" class="flex-1 px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700">ç¢ºèªç°½å</button>
            </div>
        </div>
    </div>

    <!-- æš«å­˜é€²åº¦ Modal -->
    <div id="temp-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="bg-amber-500 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-save mr-2"></i>æš«å­˜é€²åº¦ç¢ºèª</h3>
                <button onclick="closeModal('temp-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">ç™»è¨˜äººå“¡å§“å</label>
                <input type="text" id="registrar-name" class="w-full p-3 border rounded-xl mb-4 outline-none focus:ring-2 focus:ring-amber-500" placeholder="è«‹è¼¸å…¥å§“å">
                <p class="text-[10px] text-gray-400 mb-2">æœ¬æ¬¡è®Šæ›´é è¦½ï¼š</p>
                <div id="change-preview" class="text-xs bg-gray-50 p-3 rounded-lg max-h-40 overflow-y-auto mb-6 border font-mono"></div>
                <div class="flex gap-3">
                    <button onclick="closeModal('temp-modal')" class="flex-1 py-3 border rounded-xl hover:bg-gray-100 transition-colors">å–æ¶ˆ</button>
                    <button onclick="confirmSave()" id="save-btn" class="flex-1 py-3 bg-amber-500 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-all">ç¢ºèªå„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-50 p-4">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="font-bold text-xl text-gray-800 flex items-center"><i class="fas fa-mobile-alt mr-2 text-blue-600"></i>æ‰‹æ©Ÿç›¤é» V3.8</h1>
            <button onclick="fetchData()" class="text-blue-600 text-sm font-bold hover:bg-blue-50 px-2 py-1 rounded transition-all"><i class="fas fa-sync-alt"></i> åŒæ­¥æœ€æ–°</button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4">
        <!-- é ‚éƒ¨è³‡è¨Šå¡èˆ‡äººå“¡é¸æ“‡ -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border mb-6">
            <div class="flex flex-col md:flex-row md:items-end gap-6 mb-4">
                <div>
                    <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">æ‰‹æ©Ÿç¸½æ•¸</p>
                    <p class="text-4xl font-black text-blue-600" id="total-count">0</p>
                </div>
                <div class="flex-1">
                    <p class="text-xs text-red-500 font-bold mb-2 flex items-center"><i class="fas fa-exclamation-triangle mr-1"></i> å¾…ç›¤é» (é»æ“Šè·³è½‰)ï¼š</p>
                    <div id="missing-tags" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <select id="main-user" class="w-full p-3 bg-gray-50 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- é¸å–æ­£å¼ä¸Šå‚³çš„ä¸»è²¬ç›¤é»äººå“¡ --</option>
                    <option value="æ˜•æ…ˆ">æ˜•æ…ˆ</option><option value="é›¶ä¸‰">é›¶ä¸‰</option><option value="åº­ç‘Š">åº­ç‘Š</option><option value="HAMA">HAMA</option>
                    <option value="é˜¿å¸ƒ">é˜¿å¸ƒ</option><option value="å˜‰ä½‘">å˜‰ä½‘</option><option value="å¤§è»">å¤§è»</option><option value="å† éŒ¡">å† éŒ¡</option>
                    <option value="æ•ç‘">æ•ç‘</option><option value="å­Ÿå­Ÿ">å­Ÿå­Ÿ</option><option value="é˜¿ç©†">é˜¿ç©†</option><option value="å°é›„">å°é›„</option>
                </select>

                <!-- æ–°å¢ï¼šæœå°‹åŠŸèƒ½æ¬„ä½ -->
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" id="search-input" 
                           class="w-full pl-10 pr-10 py-3 bg-gray-50 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500" 
                           placeholder="æœå°‹æ‰‹æ©Ÿç·¨è™Ÿæˆ–å‹è™Ÿ..."
                           oninput="handleSearch(this.value)">
                    <button id="clear-search" onclick="clearSearch()" class="hidden absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex overflow-x-auto border-b mb-4 text-sm no-scrollbar bg-white sticky top-[68px] z-40 rounded-t-xl">
            <button onclick="switchTab('all', this)" class="tab-btn px-6 py-4 tab-active">å…¨éƒ¨</button>
            <button onclick="switchTab('A', this)" class="tab-btn px-6 py-4 text-gray-500">A ç³»åˆ—</button>
            <button onclick="switchTab('I', this)" class="tab-btn px-6 py-4 text-gray-500">I ç³»åˆ—</button>
            <button onclick="switchTab('O', this)" class="tab-btn px-6 py-4 text-gray-500">O ç³»åˆ—</button>
            <button onclick="switchTab('C', this)" class="tab-btn px-6 py-4 text-gray-500">C ç³»åˆ—</button>
            <button onclick="switchTab('un', this)" class="tab-btn px-6 py-4 text-red-500 font-bold">âš ï¸ æœªå®Œæˆ</button>
        </div>

        <div id="grid-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
        
        <!-- ç•¶æœå°‹ä¸åˆ°çµæœæ™‚é¡¯ç¤º -->
        <div id="no-result" class="hidden py-20 text-center">
            <i class="fas fa-search-minus text-4xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ‰‹æ©Ÿ</p>
        </div>
    </main>

    <footer class="fixed bottom-0 inset-x-0 bg-white/80 backdrop-blur-md border-t p-4 flex gap-3 z-50">
        <button onclick="openTempModal()" class="flex-1 bg-amber-500 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all">æš«å­˜é€²åº¦</button>
        <button onclick="trySubmitFinal()" id="submit-btn" class="flex-1 bg-green-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all">æ­£å¼ä¸Šå‚³</button>
    </footer>

    <script>
        const DEFAULT_API = "https://script.google.com/macros/s/AKfycbybXMboZmSdTiwrOS3qWv-stFJ1q-pTTOqnyenTXVyv_1CnahhaAUfkTTdJPvHHPoWc/exec";
        const DEFAULT_UNITS = ["æ©Ÿæ«ƒ", "ä¸­ç­", "GMO", "è©•æ¸¬", "Mèˆ", "SA", "æ™šç­", "OLD_TS", "OLD_ç¶²é ", "OLD_RD5", "OLD_RD4", "OLD_RD3", "OLD_RD2", "OLD_RD1", "OLD_OPO", "ACD_RD6", "ACD_RD5", "ACD_RD4", "ACD_RD3", "ACD_RD2", "ACD_RD1", "MKT", "MIS", "å ±å»¢", "é€ä¿®"];
        
        let rawData = [];
        let availableUnits = []; 
        let currentTab = 'all';
        let searchQuery = '';
        let cloudInitialMap = {};

        // ç°½åæ¿ç›¸é—œè®Šæ•¸
        let canvas, ctx;
        let isDrawing = false;
        let currentSignTarget = null; 

        window.onload = function() {
            initApiUrl();
            fetchData();
            initCanvas();
        };

        function initApiUrl() {
            const savedUrl = localStorage.getItem('inventory_api_url');
            const input = document.getElementById('api-url-input');
            input.value = savedUrl ? savedUrl : DEFAULT_API;
        }

        function getApiUrl() {
            let url = document.getElementById('api-url-input').value.trim();
            return url ? url : DEFAULT_API;
        }

        function saveApiUrl() {
            const url = document.getElementById('api-url-input').value.trim();
            if(url) localStorage.setItem('inventory_api_url', url);
        }

        function resetApiUrl() {
            document.getElementById('api-url-input').value = DEFAULT_API;
            localStorage.removeItem('inventory_api_url');
            showMessage('ç³»çµ±è¨Šæ¯', 'å·²æ¢å¾©é è¨­ç¶²å€ï¼Œè«‹é‡æ–°æ•´ç†ã€‚', () => location.reload());
        }

        function toggleSettings() {
            document.getElementById('settings-area').classList.toggle('open');
            document.getElementById('settings-arrow').classList.toggle('rotate-180');
        }

        async function fetchData() {
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = 'åŒæ­¥é›²ç«¯è³‡æ–™ä¸­...';
            
            try {
                const API = getApiUrl();
                const res = await fetch(`${API}?t=${Date.now()}`);
                if(!res.ok) throw new Error("Network response was not ok");
                
                const data = await res.json();
                
                if (Array.isArray(data)) {
                    rawData = data;
                    availableUnits = DEFAULT_UNITS;
                } else {
                    rawData = data.inventory || [];
                    const cloudUnits = data.units || [];
                    const mergedUnits = [...DEFAULT_UNITS, ...cloudUnits];
                    availableUnits = Array.from(new Set(mergedUnits));
                }
                
                cloudInitialMap = {};
                rawData.forEach(p => cloudInitialMap[p.id] = (p.borrow_unit || "æœªç›¤é»").trim());
                render();
            } catch (e) { 
                document.getElementById('loading-overlay').style.display = 'none';
                showMessage('è®€å–å¤±æ•—', `ç„¡æ³•è®€å–è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–ç¶²è·¯ã€‚\n(${e.message})`, () => {
                    document.getElementById('settings-area').classList.add('open');
                }, true);
                return;
            }
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function initCanvas() {
            canvas = document.getElementById('sig-canvas');
            ctx = canvas.getContext('2d');
            ctx.lineWidth = 3;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e.touches[0]); });
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
            canvas.addEventListener('touchend', (e) => { e.preventDefault(); stopDrawing(); });
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }
        function startDrawing(e) { isDrawing = true; const pos = getPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
        function draw(e) { if (!isDrawing) return; const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); }
        function stopDrawing() { isDrawing = false; }
        function clearSignature() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        function setUnit(id, unit) {
            if (!unit) return; 
            const isReturn = ["æœªç›¤é»", "æ©Ÿæ«ƒ", "ä¸­ç­", "æ­¸é‚„"].includes(unit);
            
            if (!isReturn) {
                updateLocalData(id, unit, null);
                currentSignTarget = { id: id, unit: unit };
                clearSignature();
                document.getElementById('signature-modal').classList.remove('hidden');
            } else {
                updateLocalData(id, unit, null);
            }
        }

        function confirmSignature() {
            const base64 = canvas.toDataURL('image/png');
            if(currentSignTarget) {
                updateLocalData(currentSignTarget.id, currentSignTarget.unit, base64);
            }
            closeSignatureModal(true);
        }

        function closeSignatureModal(saved) {
            document.getElementById('signature-modal').classList.add('hidden');
            if (!saved && currentSignTarget) { 
                updateLocalData(currentSignTarget.id, "æœªç›¤é»", null);
            }
            currentSignTarget = null;
        }

        function updateLocalData(id, unit, signature, returnUser) {
            const p = rawData.find(x => x.id === id);
            p.borrow_unit = unit || "å‡ºå€Ÿ";
            if(signature) p.signature = signature; 
            else if (unit === "æ©Ÿæ«ƒ" || unit === "ä¸­ç­" || unit === "æ­¸é‚„") delete p.signature;
            
            if(returnUser) p.return_user = returnUser;
            else delete p.return_user;

            render();
        }

        function updateDetail(id, field, value) {
            const p = rawData.find(x => x.id === id);
            p[field] = value;
        }

        function triggerReturn(id) {
            const p = rawData.find(x => x.id === id);
            p._isReturning = true; 
            render();
            setTimeout(() => {
                const input = document.getElementById(`return-input-${id}`);
                if(input) input.focus();
            }, 100);
        }

        function cancelReturn(id) {
            const p = rawData.find(x => x.id === id);
            delete p._isReturning;
            render();
        }

        function confirmReturn(id) {
            const input = document.getElementById(`return-input-${id}`);
            const val = input.value.trim();
            if(!val) return showMessage("æé†’", "è«‹è¼¸å…¥ç¢ºèªäººå“¡å§“åï¼", null, true);
            
            const p = rawData.find(x => x.id === id);
            delete p._isReturning;
            updateLocalData(id, "æ­¸é‚„", null, val);
        }

        // æœå°‹é‚è¼¯
        function handleSearch(val) {
            searchQuery = val.trim().toLowerCase();
            const clearBtn = document.getElementById('clear-search');
            if (searchQuery) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
            render();
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            searchQuery = '';
            document.getElementById('clear-search').classList.add('hidden');
            render();
        }

        function render() {
            const container = document.getElementById('grid-container');
            const missingContainer = document.getElementById('missing-tags');
            const noResultEl = document.getElementById('no-result');
            let missingIds = [];
            container.innerHTML = '';
            missingContainer.innerHTML = '';

            let shownCount = 0;

            rawData.forEach(p => {
                const id = p.id;
                const unit = (p.borrow_unit || "æœªç›¤é»").trim();
                let status = 'neutral';
                let isKnownUnit = availableUnits.includes(unit);

                if (unit === 'æ©Ÿæ«ƒ') status = 'cabinet';
                else if (unit === 'ä¸­ç­') status = 'mid';
                else if (unit === 'å‡ºå€Ÿ' || (isKnownUnit && unit !== 'æ­¸é‚„')) status = 'borrowed';
                else if (unit === 'æ­¸é‚„') status = 'returned';

                if (status === 'neutral' || unit === 'å‡ºå€Ÿ') missingIds.push(id);

                // çµ„åˆéæ¿¾æ¢ä»¶ï¼šåˆ†é æ¨™ç±¤ + æœå°‹æ–‡å­—
                let isTabShow = (currentTab === 'all') || 
                                (currentTab === 'un' && (status === 'neutral' || unit === 'å‡ºå€Ÿ')) || 
                                (id.startsWith(currentTab));

                let isSearchShow = !searchQuery || 
                                   id.toLowerCase().includes(searchQuery) || 
                                   (p.model && p.model.toLowerCase().includes(searchQuery));

                if(isTabShow && isSearchShow) {
                    shownCount++;
                    const card = document.createElement('div');
                    let borderClass = 'border-gray-100 shadow-sm';
                    let bgClass = 'bg-white';
                    if (status === 'cabinet') { borderClass = 'border-green-400'; bgClass = 'bg-green-50/20'; }
                    else if (status === 'mid') { borderClass = 'border-amber-400'; bgClass = 'bg-amber-50/20'; }
                    else if (status === 'borrowed') { borderClass = 'border-blue-400'; bgClass = 'bg-blue-50/20'; }
                    else if (status === 'returned') { borderClass = 'border-purple-400'; bgClass = 'bg-purple-50/20'; }

                    card.className = `p-4 rounded-xl border-2 transition-all ${borderClass} ${bgClass}`;
                    card.id = `card-${id}`;
                    
                    let sigBadge = p.signature ? '<span class="ml-1 text-[10px] text-green-600 border border-green-600 px-1 rounded"><i class="fas fa-check"></i> å·²ç°½å</span>' : '';
                    let returnBadge = (status === 'returned') ? `<span class="ml-1 text-[10px] text-purple-600 border border-purple-600 px-1 rounded"><i class="fas fa-undo"></i> æ­¸é‚„: ${p.return_user}</span>` : '';

                    let cardContent = '';
                    if (p._isReturning) {
                        cardContent = `
                            <div class="mb-2">
                                <label class="text-xs font-bold text-gray-500">æ­¸é‚„ç¢ºèªäººå“¡ï¼š</label>
                                <div class="flex gap-2 mt-1">
                                    <input type="text" id="return-input-${id}" class="w-full p-2 border rounded text-sm" placeholder="è¼¸å…¥å§“å">
                                    <button onclick="confirmReturn('${id}')" class="bg-purple-600 text-white px-3 rounded text-xs">ç¢ºèª</button>
                                    <button onclick="cancelReturn('${id}')" class="bg-gray-300 text-gray-700 px-2 rounded text-xs"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                        `;
                    } else {
                        let returnBtn = (status === 'borrowed') ? 
                            `<button onclick="triggerReturn('${id}')" class="flex-1 py-2 text-xs border border-purple-300 text-purple-600 bg-white hover:bg-purple-50 rounded-lg transition-colors font-bold"><i class="fas fa-undo mr-1"></i>æ­¸é‚„</button>` : '';

                        let detailInputs = '';
                        if (status === 'borrowed') {
                            detailInputs = `
                                <div class="mt-2 pt-2 border-t border-blue-200">
                                    <div class="mb-2">
                                        <label class="block text-[10px] text-gray-500 font-bold mb-0.5">å€Ÿç”¨äºº</label>
                                        <input type="text" value="${p.borrower || ''}" oninput="updateDetail('${id}', 'borrower', this.value)" class="detail-input">
                                    </div>
                                    <div class="flex gap-2 mb-2">
                                        <div class="flex-1">
                                            <label class="block text-[10px] text-gray-500 font-bold mb-0.5">åˆ†æ©Ÿ</label>
                                            <input type="text" value="${p.extension || ''}" oninput="updateDetail('${id}', 'extension', this.value)" class="detail-input">
                                        </div>
                                        <div class="flex-1">
                                            <label class="block text-[10px] text-gray-500 font-bold mb-0.5">å‡ºå€Ÿäººå“¡</label>
                                            <input type="text" value="${p.lender || ''}" oninput="updateDetail('${id}', 'lender', this.value)" class="detail-input">
                                        </div>
                                    </div>
                                    <div class="flex items-center text-xs mt-1">
                                        <span class="mr-2 text-gray-600 font-bold">å€Ÿå……é›»å™¨æ?</span>
                                        <label class="mr-2"><input type="radio" name="charger-${id}" value="æœ‰" ${p.charger === 'æœ‰' ? 'checked' : ''} onclick="updateDetail('${id}', 'charger', 'æœ‰')"> æœ‰</label>
                                        <label><input type="radio" name="charger-${id}" value="ç„¡" ${p.charger === 'ç„¡' || !p.charger ? 'checked' : ''} onclick="updateDetail('${id}', 'charger', 'ç„¡')"> ç„¡</label>
                                    </div>
                                </div>
                            `;
                        }

                        cardContent = `
                            <div class="flex gap-1 mb-2">
                                <button onclick="setStatus('${id}', 'æ©Ÿæ«ƒ')" class="flex-1 py-2 text-xs border rounded-lg transition-colors ${status==='cabinet'?'bg-green-500 text-white font-bold border-green-600':'bg-white text-gray-400 hover:bg-gray-50'}">æ©Ÿæ«ƒ</button>
                                <button onclick="setStatus('${id}', 'ä¸­ç­')" class="flex-1 py-2 text-xs border rounded-lg transition-colors ${status==='mid'?'bg-amber-500 text-white font-bold border-amber-600':'bg-white text-gray-400 hover:bg-gray-50'}">ä¸­ç­</button>
                                <button onclick="setStatus('${id}', 'å‡ºå€Ÿ')" class="flex-1 py-2 text-xs border rounded-lg transition-colors ${status==='borrowed'?'bg-blue-500 text-white font-bold border-blue-600':'bg-white text-gray-400 hover:bg-gray-50'}">å‡ºå€Ÿ</button>
                            </div>
                            ${returnBtn ? `<div class="mb-2 flex">${returnBtn}</div>` : ''}
                            <select onchange="setUnit('${id}', this.value)" class="w-full p-2 text-xs border rounded-lg bg-white outline-none focus:ring-2 focus:ring-blue-400 ${status==='borrowed'?'':'hidden'}">
                                <option value="">-- å¿…é¸å‡ºå€Ÿå–®ä½ --</option>
                                ${availableUnits.map(u => `<option value="${u}" ${unit===u?'selected':''}>${u}</option>`).join('')}
                            </select>
                            ${detailInputs}
                        `;
                    }

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-xl font-black font-mono tracking-tight">${id}</span>
                            <div class="flex flex-col items-end">
                                <span class="text-[10px] bg-gray-100 px-1.5 py-0.5 rounded text-gray-500 font-medium mb-1">${p.model}</span>
                                ${sigBadge}
                                ${returnBadge}
                            </div>
                        </div>
                        ${cardContent}
                    `;
                    container.appendChild(card);
                }
            });

            // è™•ç†æŸ¥ç„¡çµæœçš„é¡¯ç¤º
            if (shownCount === 0) {
                noResultEl.classList.remove('hidden');
            } else {
                noResultEl.classList.add('hidden');
            }

            document.getElementById('total-count').innerText = rawData.length;
            missingIds.forEach(mid => {
                const span = document.createElement('span');
                span.className = "missing-tag bg-red-50 text-red-600 px-2 py-1 rounded-md text-[11px] font-mono font-bold border border-red-200 cursor-pointer";
                span.innerText = mid;
                span.onclick = () => {
                    const target = document.getElementById(`card-${mid}`);
                    if(target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        target.classList.add('ring-4', 'ring-red-300');
                        setTimeout(() => target.classList.remove('ring-4', 'ring-red-300'), 2000);
                    } else {
                        // å¦‚æœè©²å¡ç‰‡è¢«éš±è—äº†ï¼Œåˆ‡æ›å›å…¨éƒ¨ä¸¦é‡æ–°æœå°‹
                        clearSearch();
                        switchTab('all', document.querySelector('.tab-btn'));
                        setTimeout(() => {
                            const t = document.getElementById(`card-${mid}`);
                            if(t) t.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    }
                };
                missingContainer.appendChild(span);
            });
        }

        function setStatus(id, s) {
            const p = rawData.find(x => x.id === id);
            if (s === 'æ©Ÿæ«ƒ' || s === 'ä¸­ç­') {
                delete p.signature;
                delete p.return_user;
                delete p._isReturning;
                delete p.borrower;
                delete p.extension;
                delete p.charger;
                delete p.lender;
            }

            if (p.borrow_unit === s || (s === 'å‡ºå€Ÿ' && availableUnits.includes(p.borrow_unit))) {
                p.borrow_unit = "æœªç›¤é»";
            } else {
                p.borrow_unit = s;
            }
            render();
        }

        function switchTab(t, b) {
            currentTab = t;
            document.querySelectorAll('.tab-btn').forEach(x => { x.classList.remove('tab-active'); x.classList.add('text-gray-500'); });
            b.classList.add('tab-active'); b.classList.remove('text-gray-500');
            render();
        }

        function validate() {
            const invalid = rawData.filter(p => p.borrow_unit === "å‡ºå€Ÿ");
            if(invalid.length > 0) {
                showMessage("è³‡æ–™éŒ¯èª¤", `ä»¥ä¸‹æ‰‹æ©Ÿå·²é¸ã€Œå‡ºå€Ÿã€ä½†æœªé¸æ“‡å–®ä½ï¼š\n${invalid.map(x=>x.id).join(', ')}`, null, true);
                return false;
            }
            return true;
        }

        async function openTempModal() {
            if(!validate()) return;
            const localChanges = rawData.filter(p => p.borrow_unit !== cloudInitialMap[p.id]);
            if(localChanges.length === 0) return showMessage('æç¤º', "è³‡æ–™èˆ‡é›²ç«¯ä¸€è‡´ï¼Œç„¡éœ€æš«å­˜ã€‚");

            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            loadingOverlay.style.display = 'flex';
            loadingText.innerText = 'æ­£åœ¨æª¢æŸ¥é›²ç«¯è³‡æ–™è¡çª...';

            try {
                const API = getApiUrl();
                const res = await fetch(`${API}?t=${Date.now()}`);
                if(!res.ok) throw new Error("Network error");
                
                const data = await res.json();
                let freshData = Array.isArray(data) ? data : (data.inventory || []);
                const freshMap = {};
                freshData.forEach(p => freshMap[p.id] = (p.borrow_unit || "æœªç›¤é»").trim());

                const conflicts = [];
                localChanges.forEach(change => {
                    const freshStatus = freshMap[change.id];
                    const initialStatus = cloudInitialMap[change.id];
                    if (freshStatus !== initialStatus && freshStatus !== "æœªç›¤é»") {
                         conflicts.push(`â€¢ ${change.id} (å·²è¢«è®Šæ›´ç‚º: ${freshStatus})`);
                    }
                });
                loadingOverlay.style.display = 'none';
                if (conflicts.length > 0) {
                    let msg = "æš«å­˜å€å·²æœ‰è©²ç·¨è™Ÿ(æ‰‹æ©Ÿ)è³‡æ–™ï¼Œè«‹å†æ¬¡ç¢ºèªï¼\n\nä»¥ä¸‹æ‰‹æ©Ÿå·²è¢«å…¶ä»–äººæ›´æ–°ï¼š\n" + conflicts.join('\n');
                    showMessage("âŒ è³‡æ–™è¡çªè­¦å‘Š", msg, null, true);
                    return;
                }
                document.getElementById('change-preview').innerHTML = localChanges.map(c => `<div class="py-1 border-b flex justify-between"><span>${c.id}</span><span>${cloudInitialMap[c.id]} -> <b class="text-amber-600">${c.borrow_unit}</b></span></div>`).join('');
                document.getElementById('temp-modal').classList.remove('hidden');

            } catch(e) {
                loadingOverlay.style.display = 'none';
                showMessage('æª¢æŸ¥å¤±æ•—', "ç„¡æ³•é€£æ¥é›²ç«¯æª¢æŸ¥è¡çª(ç¶²è·¯éŒ¯èª¤)ã€‚" + e.message, null, true);
            }
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        async function confirmSave() {
            const name = document.getElementById('registrar-name').value.trim();
            if(!name) return showMessage('éŒ¯èª¤', "è«‹å¡«å¯«å§“åï¼", null, true);
            
            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.innerText = "å„²å­˜ä¸­...";
            
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = 'æ­£åœ¨å¯«å…¥æš«å­˜å€...';

            const inventory = rawData.filter(p => p.borrow_unit !== cloudInitialMap[p.id]).map(p => ({ 
                id: p.id, 
                status: p.borrow_unit, 
                signature: p.signature,
                return_user: p.return_user,
                borrower: p.borrower,
                extension: p.extension,
                charger: p.charger,
                lender: p.lender
            }));
            
            try {
                const API = getApiUrl();
                const fetchPromise = fetch(API, { 
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: "temp_save", registrar: name, inventory: inventory })
                });
                const timeoutPromise = new Promise(resolve => setTimeout(resolve, 3000));
                await Promise.race([fetchPromise, timeoutPromise]);

                document.getElementById('loading-overlay').style.display = 'none';
                inventory.forEach(item => { cloudInitialMap[item.id] = item.status; });
                closeModal('temp-modal');
                btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜";
                showMessage("æˆåŠŸ", "æš«å­˜æˆåŠŸï¼\nè³‡æ–™å·²åŒæ­¥è‡³å¾Œç«¯ã€‚");
            } catch(e) { 
                document.getElementById('loading-overlay').style.display = 'none';
                showMessage('éŒ¯èª¤', "å¯«å…¥å¤±æ•—(ç¶²è·¯éŒ¯èª¤)ï¼š" + e, null, true);
                btn.disabled = false; btn.innerText = "ç¢ºèªå„²å­˜";
            }
        }

        function trySubmitFinal() {
            if(!validate()) return;

            const uninventoried = rawData.filter(p => !p.borrow_unit || p.borrow_unit === "æœªç›¤é»");
            
            if (uninventoried.length > 0) {
                let idList = uninventoried.map(p => p.id).join(', ');
                let displayList = idList;
                if (idList.length > 150) {
                    displayList = idList.substring(0, 150) + "...ç­‰å…± " + uninventoried.length + " ç­†";
                }
                
                showMessage("ç„¡æ³•ä¸Šå‚³", `âš ï¸ å°šæœ‰ ${uninventoried.length} ç­†æ‰‹æ©Ÿæœªç›¤é»ï¼\n\nè«‹ç¢ºèªä»¥ä¸‹æ‰‹æ©Ÿç‹€æ…‹å¾Œå†é€²è¡Œæ­£å¼ä¸Šå‚³ï¼š\n${displayList}`, null, true);
                return;
            }

            const name = document.getElementById('main-user').value;
            if(!name) return showMessage("éŒ¯èª¤", "è«‹é¸å–ã€Œæ­£å¼ä¸Šå‚³çš„ä¸»è²¬ç›¤é»äººå“¡ã€ï¼", () => document.getElementById('main-user').focus(), true);
            showConfirmDialog("ç¢ºèªæ­£å¼ä¸Šå‚³ï¼Ÿ", "å°‡è¦†è“‹é›²ç«¯çš„ã€Œä»Šæ—¥ç›¤é»è³‡æ–™ã€ä¸¦æ¸…ç©ºæš«å­˜å€ã€‚", executeFinalSubmit);
        }

        async function executeFinalSubmit() {
            const name = document.getElementById('main-user').value;
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
            document.getElementById('loading-text').innerText = 'æ­£åœ¨æ­£å¼ä¸Šå‚³è³‡æ–™ï¼Œè«‹ç¨å¾Œ...';

            const inventory = rawData.map(p => ({ 
                id: p.id, 
                status: p.borrow_unit, 
                signature: p.signature,
                return_user: p.return_user,
                borrower: p.borrower,
                extension: p.extension,
                charger: p.charger,
                lender: p.lender
            }));
            
            try {
                const API = getApiUrl();
                const fetchPromise = fetch(API, { 
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                    body: JSON.stringify({ action: "submit", registrar: name, inventory: inventory })
                });
                const timeoutPromise = new Promise(resolve => setTimeout(resolve, 10000));
                await Promise.race([fetchPromise, timeoutPromise]);
                
                loadingOverlay.style.display = 'none';
                showMessage("ä¸Šå‚³æˆåŠŸ", "ğŸ‰ è«‹æ±‚å·²ç™¼é€ï¼\nç³»çµ±å°‡è‡ªå‹•é‡æ•´ã€‚", () => location.reload());
            } catch(e) { 
                loadingOverlay.style.display = 'none';
                showMessage("ä¸Šå‚³å¤±æ•—", "æäº¤éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š" + e, null, true);
                btn.disabled = false;
            }
        }

        function showConfirmDialog(title, message, onConfirm) {
            const modal = document.getElementById('system-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('modal-actions').innerHTML = `
                <button id="modal-cancel-btn" class="flex-1 py-2 border border-gray-300 rounded-lg text-gray-600 font-bold hover:bg-gray-50">å–æ¶ˆ</button>
                <button id="modal-confirm-btn" class="flex-1 py-2 rounded-lg bg-green-600 text-white font-bold shadow hover:bg-green-700">ç¢ºå®šæäº¤</button>
            `;
            document.getElementById('modal-cancel-btn').onclick = () => modal.classList.add('hidden');
            document.getElementById('modal-confirm-btn').onclick = () => { modal.classList.add('hidden'); onConfirm(); };
            modal.classList.remove('hidden');
        }
        function showMessage(title, message, callback = null, isError = false) {
            const modal = document.getElementById('system-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('modal-actions').innerHTML = `<button id="modal-ok-btn" class="flex-1 py-2 rounded-lg text-white font-bold shadow bg-blue-600 hover:bg-blue-700">ç¢ºå®š</button>`;
            document.getElementById('modal-ok-btn').onclick = () => { modal.classList.add('hidden'); if(callback) callback(); };
            modal.classList.remove('hidden');
        }
    </script>
</body>
</html>
